# 前后端联调问题排查指南

## 一、404错误排查

### 1.1 检查后端服务是否启动

**检查方法**：
1. 访问后端健康检查接口：`http://localhost:8080/api`
2. 访问 Knife4j 文档：`http://localhost:8080/api/doc.html`
3. 查看后端控制台日志，确认服务已启动

**如果后端未启动**：
```bash
cd research-backend
mvn spring-boot:run
# 或使用IDE运行 ResearchBackendApplication
```

### 1.2 检查后端端口配置

**检查文件**：`research-backend/src/main/resources/application.yml`

```yaml
server:
  port: 8080
  servlet:
    context-path: /api
```

**确认**：
- 端口是否为 8080
- context-path 是否为 `/api`

### 1.3 检查前端代理配置

**检查文件**：`research-frontend/vite.config.js`

```javascript
server: {
  port: 3000,
  proxy: {
    '/api': {
      target: 'http://localhost:8080',
      changeOrigin: true,
      // 注意：不要重写路径，因为后端设置了 context-path: /api
    },
  },
}
```

**确认**：
- target 是否为 `http://localhost:8080`
- 是否有 `rewrite` 规则（如果有，需要注释掉）

### 1.4 检查前端请求路径

**检查文件**：`research-frontend/src/utils/request.js`

```javascript
const service = axios.create({
  baseURL: import.meta.env.VITE_APP_BASE_API || '/api',
  // ...
})
```

**确认**：
- baseURL 是否为 `/api`

**检查 API 文件**：`research-frontend/src/api/user.js`

```javascript
export function getUserList(params) {
  return request({
    url: '/system/user/list',  // 注意：这里不需要 /api 前缀
    method: 'get',
    params
  })
}
```

**确认**：
- API 路径是否正确（不需要 `/api` 前缀，因为 baseURL 已经包含）

### 1.5 完整请求路径分析

**前端请求流程**：
1. 前端代码：`request({ url: '/system/user/list' })`
2. 加上 baseURL：`/api/system/user/list`
3. 代理转发：`http://localhost:8080/api/system/user/list`
4. 后端接收：`/api/system/user/list`（匹配 context-path）

**如果路径不匹配，检查**：
- baseURL 是否正确
- 代理配置是否正确
- 后端 context-path 是否正确

---

## 二、其他常见问题

### 2.1 CORS跨域问题

**错误信息**：`Access-Control-Allow-Origin`

**解决方案**：
后端已配置 CORS，检查 `SecurityConfig` 中的 CORS 配置：

```java
@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    configuration.setAllowedOriginPatterns(Arrays.asList("*"));
    configuration.setAllowedMethods(Arrays.asList("*"));
    configuration.setAllowedHeaders(Arrays.asList("*"));
    configuration.setAllowCredentials(true);
    // ...
}
```

### 2.2 401未授权错误

**错误信息**：`401 Unauthorized`

**可能原因**：
1. Token 未传递
2. Token 已过期
3. Token 格式错误

**检查方法**：
1. 打开浏览器开发者工具 -> Network
2. 查看请求头中是否有 `Authorization: Bearer <token>`
3. 检查 Token 是否有效

**解决方案**：
1. 重新登录获取新 Token
2. 检查 Token 存储是否正确
3. 检查请求拦截器是否正确添加 Token

### 2.3 403权限不足错误

**错误信息**：`403 Forbidden`

**可能原因**：
1. 用户没有相应权限
2. 权限标识配置错误

**检查方法**：
1. 检查后端 Controller 中的 `@PreAuthorize` 注解
2. 检查用户角色和权限

### 2.4 500服务器错误

**错误信息**：`500 Internal Server Error`

**检查方法**：
1. 查看后端控制台日志
2. 查看错误堆栈信息
3. 检查数据库连接
4. 检查 SQL 语句是否正确

### 2.5 网络连接失败

**错误信息**：`Network Error` 或 `ERR_CONNECTION_REFUSED`

**可能原因**：
1. 后端服务未启动
2. 端口被占用
3. 防火墙阻止连接

**解决方案**：
1. 确认后端服务已启动
2. 检查端口是否被占用：`netstat -ano | findstr :8080`
3. 检查防火墙设置

---

## 三、调试技巧

### 3.1 使用浏览器开发者工具

1. **打开开发者工具**：F12
2. **查看 Network 标签**：
   - 查看请求 URL
   - 查看请求方法
   - 查看请求头
   - 查看响应状态码
   - 查看响应内容

3. **查看 Console 标签**：
   - 查看 JavaScript 错误
   - 查看 API 调用日志

### 3.2 使用后端日志

1. **查看控制台日志**：
   - 查看请求是否到达后端
   - 查看 SQL 执行日志
   - 查看异常堆栈

2. **启用详细日志**：
```yaml
logging:
  level:
    com.university.research: debug
    org.springframework.security: debug
```

### 3.3 使用 Postman 测试

1. **直接测试后端接口**：
   - URL: `http://localhost:8080/api/system/user/list`
   - Method: GET
   - Headers: `Authorization: Bearer <token>`

2. **对比前端请求**：
   - 如果 Postman 可以，前端不行，检查前端配置
   - 如果 Postman 也不行，检查后端配置

---

## 四、快速检查清单

### 前端检查
- [ ] 前端开发服务器已启动（端口 3000）
- [ ] vite.config.js 代理配置正确
- [ ] request.js baseURL 配置正确
- [ ] API 文件路径正确（不需要 /api 前缀）
- [ ] Token 正确传递

### 后端检查
- [ ] 后端服务已启动（端口 8080）
- [ ] application.yml context-path 配置正确
- [ ] Controller 路径正确
- [ ] CORS 配置正确
- [ ] 数据库连接正常

### 网络检查
- [ ] 浏览器可以访问 `http://localhost:8080/api/doc.html`
- [ ] 浏览器可以访问 `http://localhost:3000`
- [ ] 防火墙未阻止连接

---

## 五、常见配置对比

### 配置方案一：后端有 context-path

**后端配置**：
```yaml
server:
  servlet:
    context-path: /api
```

**前端代理配置**：
```javascript
proxy: {
  '/api': {
    target: 'http://localhost:8080',
    changeOrigin: true,
    // 不要重写路径
  },
}
```

**前端请求**：
```javascript
url: '/system/user/list'  // 不需要 /api 前缀
```

### 配置方案二：后端无 context-path

**后端配置**：
```yaml
server:
  servlet:
    context-path: /
```

**前端代理配置**：
```javascript
proxy: {
  '/api': {
    target: 'http://localhost:8080',
    changeOrigin: true,
    rewrite: (path) => path.replace(/^\/api/, ''),  // 需要重写路径
  },
}
```

**前端请求**：
```javascript
url: '/api/system/user/list'  // 需要 /api 前缀
```

---

**当前项目使用配置方案一**，所以代理配置不需要 rewrite 规则。


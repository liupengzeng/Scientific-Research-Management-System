# 数据库初始化说明

## 一、数据库初始化步骤

### 1.1 创建数据库

1. 打开MySQL客户端（命令行、Navicat、MySQL Workbench等）
2. 以root用户或具有CREATE DATABASE权限的用户登录
3. 执行SQL脚本：
   ```sql
   source F:\Graduation Project\Scientific Research Management System\research-backend\SQL\research.sql
   ```
   
   或者直接复制 `research-backend/SQL/research.sql` 文件中的内容执行

### 1.2 验证数据库创建

执行以下SQL验证表是否创建成功：

```sql
USE research_management;

-- 查看所有表
SHOW TABLES;

-- 应该看到以下表：
-- sys_dept, sys_user, sys_role, sys_menu, sys_user_role, sys_role_menu
-- sys_operation_log, research_project_type, research_project 等
```

### 1.3 检查外键约束

```sql
-- 查看所有外键约束
SELECT 
    CONSTRAINT_NAME,
    TABLE_NAME,
    COLUMN_NAME,
    REFERENCED_TABLE_NAME,
    REFERENCED_COLUMN_NAME
FROM 
    INFORMATION_SCHEMA.KEY_COLUMN_USAGE
WHERE 
    TABLE_SCHEMA = 'research_management'
    AND REFERENCED_TABLE_NAME IS NOT NULL;
```

---

## 二、初始测试数据（可选）

如果需要添加初始测试数据，可以执行以下SQL：

### 2.1 插入部门数据

```sql
USE research_management;

-- 插入根部门
INSERT INTO sys_dept (dept_id, parent_id, dept_name, dept_code, leader, status, order_num, create_time)
VALUES 
(1, 0, '计算机科学与技术学院', 'CS001', '张院长', '0', 1, NOW());

-- 插入子部门
INSERT INTO sys_dept (parent_id, dept_name, dept_code, leader, status, order_num, create_time)
VALUES 
(1, '软件工程系', 'CS001-01', '李主任', '0', 1, NOW()),
(1, '网络工程系', 'CS001-02', '王主任', '0', 2, NOW());
```

### 2.2 插入角色数据

```sql
-- 插入系统角色
INSERT INTO sys_role (role_name, role_key, role_sort, status, create_time)
VALUES 
('超级管理员', 'admin', 1, '0', NOW()),
('科研秘书', 'research_secretary', 2, '0', NOW()),
('教师', 'teacher', 3, '0', NOW()),
('学院领导', 'college_leader', 4, '0', NOW());
```

### 2.3 插入用户数据

```sql
-- 注意：密码需要加密存储，这里使用BCrypt加密后的密码
-- 原始密码：admin123
-- BCrypt加密后：$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
INSERT INTO sys_user (username, password, real_name, user_type, email, phone, dept_id, status, create_time)
VALUES 
('admin', '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy', '系统管理员', '00', 'admin@university.edu', '13800138000', 1, '0', NOW());

-- 分配角色
INSERT INTO sys_user_role (user_id, role_id)
VALUES (1, 1); -- admin用户分配超级管理员角色
```

**重要提示**: 
- 实际项目中，密码应该在后端注册/创建用户时使用BCrypt加密
- 测试环境可以使用上面的加密密码，生产环境必须使用强密码并加密

### 2.4 插入菜单数据（可选）

```sql
-- 插入基础菜单
INSERT INTO sys_menu (menu_name, parent_id, path, component, perms, icon, menu_type, order_num, status, create_time)
VALUES 
('系统管理', 0, '/system', NULL, NULL, 'system', 'M', 1, '0', NOW()),
('用户管理', 1, '/system/user', 'system/user/index', 'system:user:list', 'user', 'C', 1, '0', NOW()),
('角色管理', 1, '/system/role', 'system/role/index', 'system:role:list', 'peoples', 'C', 2, '0', NOW());
```

---

## 三、配置数据库连接

### 3.1 修改配置文件

编辑 `research-backend/src/main/resources/application.yml`:

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/research_management?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
    username: root  # 修改为你的MySQL用户名
    password: 123456  # 修改为你的MySQL密码
```

### 3.2 验证连接

启动后端应用，检查控制台日志：
- 如果看到 "Started ResearchBackendApplication" 表示连接成功
- 如果看到数据库连接错误，检查用户名、密码、数据库名称是否正确

---

## 四、常见问题

### Q1: 执行SQL脚本时报错"数据库不存在"
**A**: 先创建数据库，再执行表创建语句

### Q2: 外键约束错误
**A**: 确保所有被引用的表先创建，按SQL脚本中的顺序执行

### Q3: 字符编码问题
**A**: 确保数据库使用utf8mb4字符集，SQL脚本中已指定

### Q4: 时区问题
**A**: 确保数据库时区设置为GMT+8，或在连接URL中指定serverTimezone=GMT%2B8

---

## 五、验收标准

- [x] 数据库 `research_management` 创建成功
- [x] 所有表创建成功（可通过 `SHOW TABLES` 验证）
- [x] 外键约束创建成功
- [x] 后端应用可以成功连接数据库
- [x] 无SQL执行错误

---

**注意**: 
- 生产环境部署时，请修改默认密码和用户名
- 定期备份数据库
- 不要在生产环境使用测试数据


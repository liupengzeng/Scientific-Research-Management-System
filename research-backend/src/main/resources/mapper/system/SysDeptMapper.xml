<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.university.research.system.mapper.SysDeptMapper">

    <!-- 结果映射 -->
    <resultMap id="DeptResult" type="com.university.research.system.domain.SysDept">
        <id property="deptId" column="dept_id"/>
        <result property="parentId" column="parent_id"/>
        <result property="deptName" column="dept_name"/>
        <result property="deptCode" column="dept_code"/>
        <result property="leader" column="leader"/>
        <result property="phone" column="phone"/>
        <result property="email" column="email"/>
        <result property="orderNum" column="order_num"/>
        <result property="status" column="status"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <!-- 查询部门列表（仅查询正常状态的部门） -->
    <select id="selectDeptList" resultMap="DeptResult">
        SELECT
            dept_id,
            parent_id,
            dept_name,
            dept_code,
            leader,
            phone,
            email,
            order_num,
            status,
            create_by,
            create_time,
            update_by,
            update_time,
            remark
        FROM sys_dept
        WHERE status = '0'
        ORDER BY order_num ASC, dept_id ASC
    </select>

    <!-- 查询所有部门（构建树使用） -->
    <select id="selectAll" resultMap="DeptResult">
        SELECT
            dept_id, parent_id, dept_name, dept_code, leader, phone, email,
            order_num, status, create_by, create_time, update_by, update_time, remark
        FROM sys_dept
        ORDER BY parent_id ASC, order_num ASC, dept_id ASC
    </select>

    <!-- 根据ID查询 -->
    <select id="selectById" parameterType="long" resultMap="DeptResult">
        SELECT
            dept_id, parent_id, dept_name, dept_code, leader, phone, email,
            order_num, status, create_by, create_time, update_by, update_time, remark
        FROM sys_dept
        WHERE dept_id = #{deptId}
    </select>

    <!-- 新增 -->
    <insert id="insertDept" parameterType="com.university.research.system.domain.SysDept" useGeneratedKeys="true" keyProperty="deptId">
        INSERT INTO sys_dept (parent_id, dept_name, dept_code, leader, phone, email,
                              order_num, status, create_by, create_time, update_by, update_time, remark)
        VALUES (#{parentId}, #{deptName}, #{deptCode}, #{leader}, #{phone}, #{email},
                #{orderNum}, #{status}, #{createBy}, NOW(), #{updateBy}, NOW(), #{remark})
    </insert>

    <!-- 修改 -->
    <update id="updateDept" parameterType="com.university.research.system.domain.SysDept">
        UPDATE sys_dept
        SET parent_id = #{parentId},
            dept_name = #{deptName},
            dept_code = #{deptCode},
            leader    = #{leader},
            phone     = #{phone},
            email     = #{email},
            order_num = #{orderNum},
            status    = #{status},
            update_by = #{updateBy},
            update_time = NOW(),
            remark    = #{remark}
        WHERE dept_id = #{deptId}
    </update>

    <!-- 删除 -->
    <delete id="deleteDeptById" parameterType="long">
        DELETE FROM sys_dept WHERE dept_id = #{deptId}
    </delete>

    <!-- 统计子部门数量 -->
    <select id="countChildren" parameterType="long" resultType="int">
        SELECT COUNT(1) FROM sys_dept WHERE parent_id = #{deptId}
    </select>

    <!-- 修改状态 -->
    <update id="updateStatus">
        UPDATE sys_dept
        SET status = #{status}, update_time = NOW()
        WHERE dept_id = #{deptId}
    </update>

</mapper>

